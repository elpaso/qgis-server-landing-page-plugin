<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
            integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
            crossorigin=""/>
    <link rel="stylesheet" href="/wfs3/static/style.css" />
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/wfs3/static/jsonFormatter.min.css" crossorigin="anonymous">
    <script src="/wfs3/static/jsonFormatter.min.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin=""/>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


    <!-- Extra css for map page -->
    <link rel="stylesheet" href="/static/css/map.css" />

    <title>{{ metadata.pageTitle }}</title>

  </head>
  <body>

    <div id="sidebarCollapse" class="leaflet-control-layers leaflet-left leaflet-control" aria-haspopup="true">
        <a class="leaflet-control-layers-toggle" href="#" title="Layers"></a>
    </div>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">{{ project.title }}</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="../../">Projects<span class="sr-only">(current)</span></a>
            </li>

        </div>
    </nav><!-- // navbar -->

    <div class="wrapper">

        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h5>Legend</h5>
            </div>

            <div id="toc"></div>

        </nav>

        <!-- map -->
        <div id="map">
            <script type="text/javascript">
                // project map
                var map;
                var wms_layers_map;
                var wms_toc_tree = {{ project.toc }};
                $(function(){
                    wms_layers_map = {{ project.wms_layers_map }};
                    {% if "EPSG:3857" in project.capabilities.wmsOutputCrsList %}
                    map = L.map('map').setView([0, 0], 13);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map)
                    {% endif %}

                    var west = {{ project.geographic_extent.0 }};
                    var south = {{ project.geographic_extent.1 }};
                    var east = {{ project.geographic_extent.2 }};
                    var north = {{ project.geographic_extent.3 }};
                    var p1 = new L.LatLng(south, west);
                    var p2 = new L.LatLng(north, west);
                    var p3 = new L.LatLng(north, east);
                    var p4 = new L.LatLng(south, east);

                    map.fitBounds([p1, p2, p3, p4]);

                    var node_counter = 0;
                    var wms_source = L.WMS.source("/project/{{ project.id }}/?", {
                        'tileSize': 512,
                        'transparent': true,
                        'format': 'image/png',
                        'dpi': window.devicePixelRatio * 96,
                    }).addTo(map);

                    var set_layer_visibility = function(e, visible)
                    {
                        if ( !visible)
                        {
                            $(e).removeClass('visible');
                            if ($(e).attr('typename'))
                                wms_source.removeSubLayer($(e).attr('typename'));
                            $(e).removeClass('fa-check-square-o');
                            $(e).addClass('fa-square-o');
                        }
                        else
                        {
                            $(e).addClass('visible');
                            if ($(e).attr('typename'))
                                wms_source.addSubLayer($(e).attr('typename'));
                            $(e).addClass('fa-check-square-o');
                            $(e).removeClass('fa-square-o');
                        }
                        $(e).parent().find('ul .node-check').each(function(i, e){
                            set_layer_visibility(e, visible);
                        });
                    };

                    var layer_factory = function(toc_node, parent_selector, depth)
                    {
                        if (toc_node.is_layer)
                        {
                            console.log("Adding " + toc_node.typename);
                            // Make a layer node
                            $(parent_selector).prepend('<li id="' + toc_node.tree_id_hash + '" class="layer"><i data-toggle="tooltip" title="Toggle layer visibility" class="node-check fa ' + (toc_node.visible ? 'fa-check-square-o visible' : 'fa-square-o') + '"></i> ' + toc_node.title + '</li>');
                            $('#' + toc_node.tree_id_hash + '> i').attr('typename', toc_node.typename);

                            if (toc_node.visible)
                                wms_source.addSubLayer(toc_node.typename);

                            $('#' + toc_node.tree_id_hash + ' > .node-check').on('click', function(e){
                                var is_visible = $(e.target).hasClass('visible');
                                set_layer_visibility(e.target, ! is_visible);
                            });
                            node_counter++;
                        }
                        else
                        {
                            try
                            {
                                if (toc_node.children.length > 0)
                                {
                                    // Make a group node if not root
                                    if (toc_node.name == 'root')
                                    {
                                        $(parent_selector).prepend('<ul class="list-unstyled" id="root-node"></ul>');
                                        child_selector = '#root-node';
                                        node_counter++;
                                        //console.log("-".repeat(depth) + " creating ROOT group " + child_selector + " " + toc_node.title + " to parent " + parent_selector);
                                        $(toc_node.children.reverse()).each(function(i, c)
                                        {
                                            //console.log("-".repeat(depth) + " ... adding child " + c.title + " to group " +  child_selector);
                                            layer_factory(c, "#root-node", depth+1);
                                        });
                                    }
                                    else
                                    {
                                        $(parent_selector).prepend('<li class="layer-group"><i data-toggle="collapse" aria-expanded="' + (toc_node.expanded ? 'true' : 'false') + '"  href="#node-' + node_counter + '" class="group-toggle fa fa-caret-' + (toc_node.expanded ? 'down' : 'right') +'"></i> <i data-toggle="tooltip" title="Toggle group visibility" id="group-node-' + node_counter + '" class="node-check fa ' + (toc_node.visible ? 'fa-check-square-o visible' : 'fa-square-o') + '"></i> <a data-toggle="collapse" aria-expanded="' + (toc_node.expanded ? 'true' : 'false') + '" href="#node-' + node_counter + '">' + toc_node.title + '</a><ul class="collapse' + (toc_node.expanded ? ' show' : '') +' list-unstyled" id="node-' + node_counter +'"></ul></li>');
                                        child_selector = '#node-' + node_counter;

                                        $('#group-node-' + node_counter).on('click', function(e){
                                            var is_visible = $(e.target).hasClass('visible');
                                            set_layer_visibility(e.target, ! is_visible);
                                        });

                                        node_counter++;
                                        (function(cs)
                                        {
                                            $(toc_node.children.reverse()).each(function(i, c)
                                            {
                                                layer_factory(c, cs, depth+1);
                                            });
                                        })(child_selector);

                                    }

                                }
                            }
                            catch (error)
                            {
                                console.log(error);
                            }
                        }
                    };

                    // Load all layers
                    layer_factory(wms_toc_tree, '#toc', 0);

                    var find_by_title = function(title, element)
                    {
                        console.log(element.title);
                        try {
                            if (element.title == title)
                            {
                                return element;
                            }
                            for(var i=0; i<element.children.length; ++i)
                            {
                                var result = find_by_title(title, element.children[i]);
                                if (result)
                                {
                                    return result;
                                }
                            }
                        } catch (error) {
                            console.log('Error'); // Ignore
                        }
                        return false;
                    }

                    var toc_url = "/project/{{ project.id }}/?SERVICE=WMS&REQUEST=GetLegendGraphics&LAYERS={{ project.wms_root_name }}&FORMAT=application/json";
                    $.getJSON(toc_url, function( data )
                    {
                        var walker = function(i, node)
                        {
                            var e = find_by_title(node.title, wms_toc_tree);
                            if (e)
                            {
                                if (typeof(node.symbols) != "undefined")
                                {
                                    $('#' + e.tree_id_hash).append('<ul class="symbols list-unstyled"></ul>');
                                    for(var i=0; i<node.symbols.length; ++i)
                                    {
                                        var symbol = node.symbols[i];
                                        $('#' + e.tree_id_hash+ ' ul').append('<li><img class="symbol" src="data:image/png;base64,' + symbol.icon + '" /> ' + symbol.title + '</li>')
                                    }
                                }
                                else
                                {
                                   $('#' + e.tree_id_hash + ' i.fa').append('<img class="symbol" src="data:image/png;base64,' + node.icon + '" /> ');
                                }
                            }
                        };
                        $.each(data.nodes, walker);
                    });
                });

            </script>
        </div><!-- // #map -->

        {% if debug %}
        <pre class="jref">
            {{ json_dump() }}
        </pre>
        {% endif %}


    </div><!-- // .wrapper -->


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
       integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
       crossorigin="">
    </script>
    <script src="/static/js/leaflet.wms.js"></script>
    <script>
        $('.jref').jsonFormatter();

        $(function(){
            $('#sidebarCollapse').on('click', function (e) {
                $("#sidebar").animate({
                    width: "toggle"
                }, 350, function() {
                    map.invalidateSize();
                    $('#sidebar').toggleClass('active');
                });
                e.preventDefault();
                return false;
            });
            // Move it where it belongs
            $('.leaflet-control-container').append($('#sidebarCollapse'));
        });

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
  </body>
</html>
